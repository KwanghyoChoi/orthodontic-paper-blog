# Orthodontic Paper to Blog System - Workflow Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    ORTHODONTIC PAPER TO BLOG SYSTEM                             │
│                         전체 워크플로우 구조도                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │  INPUT PDF  │
                              │ input/*.pdf │
                              └──────┬──────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       PHASE 1: CONTENT GENERATION                               │
│                       claude "논문 분석 시작: ..."                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                                                            │
│  │ paper_analyzer  │  논문 핵심 추출 + 복잡도 판단                               │
│  └────────┬────────┘                                                            │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐     ┌──────────────────────────────────────┐              │
│  │research_expander│────►│ Perplexity Sonar Deep Research API   │              │
│  │ (sonar-deep)    │◄────│ tools/sonar_api.py                   │              │
│  └────────┬────────┘     └──────────────────────────────────────┘              │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐                                                            │
│  │   comparator    │  연구 간 비교 + 논쟁점 분석                                 │
│  └────────┬────────┘                                                            │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐     ┌──────────────────────────────────────┐              │
│  │  image_curator  │────►│ extractors/pdf_page_renderer.py      │              │
│  │ (Claude Vision) │     │ extractors/crop_figures_[논문ID].py  │              │
│  └────────┬────────┘     └──────────────────────────────────────┘              │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐               │
│  │  ⚠️ CROP VERIFICATION LOOP (최대 3회)                        │               │
│  │                                                              │               │
│  │  크롭 실행 → Vision 검증 → 문제시 좌표 조정 → 재크롭        │               │
│  │                                                              │               │
│  │  검증 항목:                                                  │               │
│  │  • Figure 내용 완전성 (a,b,c... 모든 패널)                  │               │
│  │  • 캡션 포함 여부                                            │               │
│  │  • 다이어그램 축/레이블 잘림 여부                            │               │
│  └────────┬────────────────────────────────────────────────────┘               │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐                                                            │
│  │   blog_writer   │  블로그 초안 생성 (Sonnet 4.5)                              │
│  │                 │  ⚠️ "다른 연구들은?" 섹션 필수 포함                         │
│  └────────┬────────┘                                                            │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────┐                                                            │
│  │quality_reviewer │  검토 + score < 0.7 시 재호출 (max 2회)                     │
│  └────────┬────────┘                                                            │
│           │                                                                     │
│           ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐               │
│  │                      OUTPUT (Phase 1)                        │               │
│  │  • output/*.md                    (블로그 마크다운)           │               │
│  │  • output/images/selected/*.png   (Figure 이미지)            │               │
│  │  • output/latest_research.md      (관련 연구 정리)           │               │
│  └─────────────────────────────────────────────────────────────┘               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │           [HUMAN]              │
                    │                                │
                    │   • 글 내용 검토               │
                    │   • 이미지 확인                │
                    │   • 수정 요청 또는 승인        │
                    │                                │
                    └───────────────┬────────────────┘
                                    │ 승인
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       PHASE 2: PUBLISHING (자동)                                │
│                python tools/publish_blog.py output/*.md --publish               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Step 1: Image Processing                                                 │   │
│  │ tools/image_processor.py                                                 │   │
│  │                                                                          │   │
│  │  PNG (667KB) ──────► WebP (273KB)  [59% 감소]                            │   │
│  │  output/images/selected/*.png → output/images/selected/webp/*.webp       │   │
│  └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Step 2: Google Drive Upload                                              │   │
│  │ tools/gdrive_uploader.py                                                 │   │
│  │                                                                          │   │
│  │  WebP 이미지 ──────► Google Drive                                        │   │
│  │                      (GOOGLE_DRIVE_FOLDER_ID)                            │   │
│  │                            │                                             │   │
│  │                            ▼                                             │   │
│  │             https://lh3.googleusercontent.com/d/{FILE_ID}                │   │
│  │                            │                                             │   │
│  │                            ▼                                             │   │
│  │              gdrive_urls.json (URL 매핑)                                 │   │
│  └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Step 3: Content Preparation                                              │   │
│  │ tools/wordpress_publisher.py                                             │   │
│  │                                                                          │   │
│  │  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐         │   │
│  │  │ Markdown 읽기  │───►│ 이미지 URL 치환│───►│  HTML 변환     │         │   │
│  │  │ (YAML 파싱)    │    │ (GDrive URLs)  │    │  (markdown)    │         │   │
│  │  └────────────────┘    └────────────────┘    └────────────────┘         │   │
│  │                                                      │                   │   │
│  │                                                      ▼                   │   │
│  │                              _publish_config.json (발행 설정)            │   │
│  │                              • title, excerpt, category                  │   │
│  │                              • tags, focus_keyword                       │   │
│  └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Step 4: WordPress Publishing                                             │   │
│  │ tools/wordpress_publisher.py                                             │   │
│  │                                                                          │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    WordPress REST API                             │   │   │
│  │  │                    (WORDPRESS_URL/wp-json/wp/v2)                  │   │   │
│  │  ├──────────────────────────────────────────────────────────────────┤   │   │
│  │  │                                                                   │   │   │
│  │  │  POST /posts                                                      │   │   │
│  │  │  • title: 글 제목                                                 │   │   │
│  │  │  • content: HTML 본문                                             │   │   │
│  │  │  • categories: [최신 치과교정학 연구]                             │   │   │
│  │  │  • tags: [투명교정, 인비절라인, ...]                              │   │   │
│  │  │  • status: publish                                                │   │   │
│  │  │                                                                   │   │   │
│  │  │  POST /posts/{id} (meta)                                          │   │   │
│  │  │  • fifu_image_url: 논문 첫 페이지 (대표이미지)                    │   │   │
│  │  │  • rank_math_focus_keyword: Focus 키워드                          │   │   │
│  │  │                                                                   │   │   │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         OUTPUT (Phase 2)                                 │   │
│  │                                                                          │   │
│  │  • 발행된 글 URL: https://blog.honorsdental.com/...                     │   │
│  │  • _publish_result.json (발행 결과)                                     │   │
│  │  • Post ID, 상태, 에러 로그                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 환경 설정 (.env)

```bash
# Perplexity API (연구 검색)
PERPLEXITY_API_KEY=pplx-...

# WordPress (글 발행)
WORDPRESS_URL=https://blog.honorsdental.com
WORDPRESS_USERNAME=...
WORDPRESS_APP_PASSWORD=...

# Google Drive (이미지 호스팅)
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REFRESH_TOKEN=...
GOOGLE_DRIVE_FOLDER_ID=...
```

---

## 프로젝트 구조

```
orthodontic-paper-blog/
│
├── CLAUDE.md                    # 오케스트레이터 + 프로젝트 문서
├── WORKFLOW.md                  # 워크플로우 구조도 (이 파일)
├── .env                         # 환경 변수 (API 키)
│
├── agents/                      # 에이전트 정의
│   ├── paper_analyzer.md
│   ├── research_expander.md     # Sonar Deep Research
│   ├── comparator.md
│   ├── image_curator.md         # Claude Vision
│   ├── blog_writer.md           # Sonnet 4.5
│   ├── quality_reviewer.md
│   └── blog_publisher.md        # Phase 2 발행
│
├── extractors/                  # PDF 처리 도구
│   ├── pdf_page_renderer.py     # PDF → 페이지 이미지
│   └── crop_figures.py          # Figure 크롭
│
├── tools/                       # API 연동 도구
│   ├── sonar_api.py             # Perplexity Sonar
│   ├── image_processor.py       # PNG → WebP
│   ├── gdrive_uploader.py       # Google Drive
│   ├── wordpress_publisher.py   # WordPress REST API
│   └── publish_blog.py          # 통합 발행 파이프라인
│
├── input/                       # 입력 논문 PDF
│   └── *.pdf
│
└── output/                      # 생성 결과물
    ├── *.md                     # 블로그 마크다운
    ├── *_publish_config.json    # 발행 설정
    ├── *_publish_result.json    # 발행 결과
    ├── latest_research.md       # 관련 연구 정리
    └── images/
        ├── pages/               # 렌더링된 PDF 페이지
        └── selected/            # 선별된 Figure
            └── webp/            # WebP 변환 + URL 매핑
```

---

## 실행 방법

### Phase 1: 콘텐츠 생성
```bash
claude "논문 분석 시작: input/[논문파일명].pdf"
```

### Phase 2: 발행 (Human 승인 후)
```bash
python tools/publish_blog.py output/[블로그파일].md --publish
```

---

## 에이전트 역할

| 에이전트 | 역할 | 모델/도구 |
|---------|------|----------|
| paper_analyzer | 논문 핵심 추출 + 복잡도 판단 | Claude |
| research_expander | 관련/반박 연구 검색 | Sonar Deep Research |
| comparator | 연구 간 비교 + 논쟁점 분석 | Claude |
| image_curator | Figure 식별 + 크롭 + **검증 루프** | Claude Vision |
| blog_writer | 블로그 초안 + **연구 비교 섹션** | Sonnet 4.5 |
| quality_reviewer | 품질 검토 + 재호출 판단 | Claude |
| blog_publisher | WordPress 발행 | REST API |

---

## ⚠️ 필수 워크플로우 (2025 업데이트)

### 1. 관련 연구 비교 섹션 (blog_writer)

블로그에 **"다른 연구들은 뭐라고 하나?"** 섹션을 **반드시** 포함:

```markdown
## 다른 연구들은 뭐라고 하나?

### Rossini et al. (2015) - Angle Orthodontist
| 이동 유형 | 달성률 | 본 논문 | 비교 |
|---------|-------|--------|-----|
| 전반적 이동 | 41% | - | - |
| 회전 | 45-65% | 36% | 본 논문이 보수적 |

### 본 논문 vs 기존 연구
| 항목 | 본 논문 | 기존 연구 | 해석 |
|-----|--------|----------|-----|
| 구치 원심이동 | 88% | 60-70% | 본 논문이 낙관적 |

### 왜 수치가 다른가?
1. 측정 방법 차이
2. 대상 환자 차이
3. 시스템 차이
```

**❌ 잘못된 예:** 참고문헌에만 논문 나열하고 본문에서 언급 안 함
**✅ 올바른 예:** 본문에서 구체적 수치와 함께 비교 분석

### 2. 이미지 크롭 검증 루프 (image_curator)

```
┌──────────────────────────────────────────────────────────────┐
│                  CROP VERIFICATION LOOP                       │
│                                                               │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│  │  크롭   │───►│ Vision  │───►│ 문제?   │─Y─►│좌표 조정│   │
│  │  실행   │    │  검증   │    │         │    │         │   │
│  └─────────┘    └─────────┘    └────┬────┘    └────┬────┘   │
│       ▲                             │N             │         │
│       │                             │              │         │
│       │                             ▼              │         │
│       │                        ┌─────────┐        │         │
│       │                        │  완료   │        │         │
│       │                        └─────────┘        │         │
│       │                                           │         │
│       └───────────────────────────────────────────┘         │
│                        (최대 3회 반복)                        │
└──────────────────────────────────────────────────────────────┘
```

**검증 체크리스트:**
- [ ] Figure 내용이 모두 포함되었는가? (a,b,c... 모든 패널)
- [ ] 캡션이 잘리지 않았는가?
- [ ] 다이어그램의 축, 레이블이 완전한가?
- [ ] 불필요한 여백이 과도하지 않은가?

**좌표 조정 가이드:**
| 문제 | 해결 |
|-----|-----|
| 하단 잘림 | bottom 값 증가 |
| 상단 잘림 | top 값 감소 |
| 캡션 누락 | bottom을 캡션 끝까지 확장 |

---

## 주요 기능

- **이미지 최적화**: PNG → WebP (약 59% 용량 감소)
- **이미지 호스팅**: Google Drive (lh3.googleusercontent.com)
- **대표이미지**: FIFU 플러그인 (논문 첫 페이지 우선)
- **SEO**: Rank Math Focus 키워드 자동 설정
- **카테고리**: "최신 치과교정학 연구" 자동 분류
